name: CI/CD

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-java@v1
          with:
            java-version: '12.x'
        - uses: subosito/flutter-action@v1
          with:
            channel: dev
        - run: flutter config --enable-web
        - run: flutter pub get
        - run: flutter test
        - run: flutter build web
        - run: flutter build apk
        - uses: r0adkll/sign-android-release@v1
          name: Sign app APK
          id: sign_app
          with:
            releaseDirectory: build/app/outputs/flutter-apk/
            signingKeyBase64: ${{ secrets.SIGNING_KEY }}
            alias: 'key'
            keyStorePassword: ${{ secrets.KEY_PASSWORD }}
            keyPassword: ${{ secrets.KEY_PASSWORD }}
        - run: flutter build ios --release --no-codesign
        - uses: actions/setup-ruby@v1
          with:
            ruby-version: '>= 2.6'
        - name: Set up Google Key
          run: |
            echo "$GOOGLE_KEYFILE" > ./ios/gc_keys.json
          env:
            GOOGLE_KEYFILE: ${{ secrets.GOOGLE_KEYFILE }}
        - uses: maierj/fastlane-action@v2.0.0
          with:
            lane: 'beta'
            subdirectory: 'ios'          
        - name: Set up SSH
          run: |
            mkdir -p ~/.ssh/
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            sudo chmod 600 ~/.ssh/id_rsa
            echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts              
          env:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        - name: deploy
          run: |
            mkdir ${GITHUB_SHA::8}
            cp ${{steps.sign_app.outputs.signedReleaseFile}} ${GITHUB_SHA::8}/
            cp build/Runner.ipa ${GITHUB_SHA::8}/
            cp -r build/web ${GITHUB_SHA::8}/web
            scp -r ${GITHUB_SHA::8} cnwesleywang@35.203.63.151:/var/www/html/cicd/
            ssh cnwesleywang@35.203.63.151 "ln -s /var/www/html/cicd/${GITHUB_SHA::8} /var/www/html/cicd/current"

